<?php 
	session_start();
	include "connection/connect.php";
	$adminRole = isset($_SESSION['admin_name'])?$_SESSION['admin_name']:"";
	if(isset($_POST['submit'])){
		$sql="INSERT INTO toa_tot_calendar (title, start_date, end_date, state_id, city_id, adress, batch_type, fees, jobrole_id, batch_id, batch_id_sip, status, post_date) VALUES ('".$_POST['txttitle']."','".$_POST['txtstart']."','".$_POST['txtend']."','".$_POST['txtstate']."','".$_POST['txtcity']."','".$_POST['txtaddress']."','".$_POST['batch_type']."','".$_POST['txtfee']."','".$_POST['txtjobrole']."','".$_POST['txtbatchid']."','".$_POST['txtbatchidsip']."','".$_POST['txtstatus']."',now())";    
		$exe = mysqli_query($mysqli,$sql);    
		if(mysqli_affected_rows($mysqli)>0)    {
			header('Location:insert_calender.php?ins');
		}	
	}
	$viewSecQry = "SELECT * FROM toa_tot_calendar ORDER by calendar_id DESC";
	$exeSecQry = mysqli_query($mysqli,$viewSecQry);
	$table="";
	$count=0;
	while($row = mysqli_fetch_array($exeSecQry)) { 
		$count+=1; 
		$calendar_id= $row['calendar_id'];
		$title= $row['title']; 
		$batch_type= $row['batch_type']; 
		$start_date= $row['start_date']; 
		$end_date= $row['end_date']; 
		$state_id= $row['state_id']; 
		$city_id= $row['city_id']; 
		$staten = "SELECT * FROM states WHERE id='".$state_id."'"; 
		$qurstaten = mysqli_query($mysqli,$staten); 
		$arresstaten = mysqli_fetch_assoc($qurstaten);
		$sqln = "SELECT * FROM cities WHERE id = '".$city_id."'";
		$exen = mysqli_query($mysqli,$sqln);
		$arrn = mysqli_fetch_array($exen);  
		$uploaded_date= $row['post_date']; 
		$newDate = date("d-m-Y h:i:s",strtotime($uploaded_date));  
		$table.="<tr>            <td>$count </td>            <td>$title</td>            <td>$batch_type</td>            <td>$start_date <br/> $end_date</td>            <td>{$arresstaten['name']} / {$arrn['name']}</td>            <td>$newDate</td>            <td>              <a class='btn btn-info update btn-xs' href='update_calender.php?id=$calendar_id'><i class='fa fa-pencil'></i> edit</a>              <a class='btn btn-danger update btn-xs delete' data-id='$calendar_id'><i class='fa fa-trash'></i> Delete</a>              <a class='btn btn-success update btn-xs delete' href='screening_application.php?id=$calendar_id'><i class='fa fa-download'></i> Screening</a>               <a class='btn btn-success update btn-xs delete' href='final_application.php?id=$calendar_id'><i class='fa fa-download'></i> Final Application</a>             </td>        </tr>";
	}
	$jobrole = "SELECT * FROM jobrole";
	$qurjobrole = mysqli_query($mysqli,$jobrole);
	$jobroleList=""; 
	while($arresjobrole = mysqli_fetch_assoc($qurjobrole)){ 
		$jobroleList .= "<option value='{$arresjobrole['jobrole_id']}'>{$arresjobrole['jobrole_name']}</option>";
	}
	$state = "SELECT * FROM states";
	$qurstate = mysqli_query($mysqli,$state);
	$stateList="";
	while($arresstate = mysqli_fetch_assoc($qurstate)){ 
		$stateList .= "<option value='{$arresstate['id']}'>{$arresstate['name']}</option>";
	}
	if(isset($_REQUEST['get']))    {  
		switch($_REQUEST['get'])   {   
			case 'cities':   {        
				$sql = "SELECT * FROM cities WHERE state_id = '".$_POST['id']."'";   
				$exe =mysqli_query($mysqli,$sql);       
				while($arr = mysqli_fetch_array($exe))  {  
					echo "<option value='{$arr['id']}'>{$arr['name']}</option>";            
				} 
			}          
			die;            break;   
		} 
	}if($adminRole !=""){
			?><!DOCTYPE html><html lang="en">  <head>	<?php include("include/header.php");?>  <link rel="stylesheet" href="css/froala_editor.css">  <link href="vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css" rel="stylesheet">  </head>  <body class="nav-md">    <div class="container body">      <div class="main_container">	          <?php include("include/left-menu.php");?>        <!-- top navigation -->        		<?php include("include/top_nav.php");?>	        <!-- page content -->        <div class="right_col" role="main">          <div class="">            <div class="page-title">              <div class="title_left">                              </div>            </div>            <div class="clearfix"></div>              <?php              		              		if(isset($_GET['upd']))              		{              			echo " <div class='alert alert-success alert-dismissible fade in' role='alert'>                                  <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>×</span>                                  </button>                                  <strong>Calendar has been Updated successfully</strong>                                </div>";              		}              		              		              		              		if(isset($_GET['ins']))              		{              			echo " <div class='alert alert-success alert-dismissible fade in' role='alert'>                                  <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>×</span>                                  </button>                                  <strong>Calendar has been inserted Successfully</strong>                                </div>";              		}              	                	  if(isset($_GET['npdel']))              	  {              		echo " <div class='alert alert-danger alert-dismissible fade in' role='alert'>                                  <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>×</span>                                  </button>                                  <strong>It can't be deleted.This Product is linked.</strong>                                </div>";                    }              	                	  if(isset($_GET['del']))              	  {              		echo " <div class='alert alert-danger alert-dismissible fade in' role='alert'>                                  <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>×</span>                                  </button>                                  <strong>Banner has been Deleted Successfully</strong>                                </div>";                    }              		              		                   	              	              ?>            <div class="row">              <div class="col-md-12 col-sm-12 col-xs-12">                <div class="x_panel">                  <div class="x_title">                    <h2>Insert Calendar <small>Add calendar in IPSC Website</small></h2>                    <ul class="nav navbar-right panel_toolbox">                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>                      </li>                                           <li><a class="close-link"><i class="fa fa-close"></i></a>                      </li>                    </ul>                    <div class="clearfix"></div>                  </div>                                   <div class="x_content">                   <form id="basicForm" class="form-horizontal" method="post" enctype="multipart/form-data">          <div class="form-layout form-layout-1">            <div class="row mg-b-25">              <div class="col-lg-12">                <div class="form-group">                  <label class="form-control-label">TOT/TOA Title: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                  <input type="text" name="txttitle" class="form-control required" required="">                </div>              </div><!-- col-4 -->              <div class="col-lg-4">                   <div class="form-group">                    <label>Job role: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                        <select class="form-control" name="txtjobrole" required="">                          <option value="">--Select--</option>                          <?php echo $jobroleList; ?>                                                 </select>                    </div>              </div>                <div class="col-lg-4">                   <div class="form-group">                  <label class="form-control-label">Start Date: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                      <div class="input-group date" id="myDatepicker1">                            <input type="text" name="txtstart" class="form-control" readonly="readonly" required="">                            <span class="input-group-addon">                               <span class="glyphicon glyphicon-calendar"></span>                            </span>                        </div>                                  </div>              </div>                <div class="col-lg-4">                  <div class="form-group">                    <label>End Date:</label>                        <div class="input-group date" id="myDatepicker2">                            <input type="text" class="form-control" name="txtend" readonly="readonly" required="">                            <span class="input-group-addon">                               <span class="glyphicon glyphicon-calendar"></span>                            </span>                        </div>                    </div>              </div>			       <div class="col-lg-2">               <div class="form-group">                    <label>State: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                       <select class="form-control" id="state" required="" name="txtstate">                         <option value="">--Select--</option>                         <?php echo $stateList; ?>                       </select>                    </div>              </div>			                    <div class="col-lg-2">               <div class="form-group">                    <label>City: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                          <select class="form-control" name="txtcity" id="district" required="">                           <option value="">--Select--</option>                         </select>                    </div>              </div>                <div class="col-lg-8">                <div class="form-group">                  <label class="form-control-label">Location/Address: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                  <input type="text" name="txtaddress" class="form-control required" onKeyPress="return onlyAlphabets(event,this);" required="" />                </div>              </div><!-- col-4 -->              <div class="col-lg-4">                <div class="form-group">                    <label>Batch Type: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                          <select class="form-control" required="" name="batch_type">                           <option value="">--Select--</option>                           <option value="New Trainers">New Trainers</option>                           <option value="Existing Trainers">Existing Trainers</option>                         </select>                    </div>              </div>              <div class="col-lg-4">                <div class="form-group">                    <label>Batch ID: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                        <input type="text" name="txtbatchid" class="form-control" required="">                    </div>              </div>               <div class="col-lg-4">               <div class="form-group">                    <label>Batch ID on SIP: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                        <input type="text" name="txtbatchidsip" class="form-control" required="">                    </div>              </div>               <div class="col-lg-4">                <div class="form-group">                    <label>Fees: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                       <input type="text" name="txtfee" class="form-control" required="">                    </div>              </div>                <div class="col-lg-4">                <div class="form-group">                    <label>Status: <span class="tx-danger" style="font-size: 11px; color: red;">*</span></label>                        <select class="form-control" name="txtstatus" required="">                          <option value="">--Select--</option>                          <option value="Created">Created</option>                          <option value="Completed">Completed</option>                        </select>                    </div>              </div>             </div><!-- row -->            <div class="row">               <div class="col-lg-4" style="margin-top:10px;">                <div class="form-group">                  <button class="btn btn-primary" name="submit">Publish Calendar</button>                </div>              </div><!-- col-4 -->            </div>                     </div><!-- form-layout -->		  </form>                  </div>                </div>              </div>            </div>											    <div class="row">              <div class="col-md-12 col-sm-12 col-xs-12">                <div class="x_panel">                  <div class="x_title">                    <h2>View Calendar <small>View calendar in IPSC Website</small></h2>                    <ul class="nav navbar-right panel_toolbox">                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>                      </li>                                           <li><a class="close-link"><i class="fa fa-close"></i></a>                      </li>                    </ul>                    <div class="clearfix"></div>                  </div>                                   <div class="x_content">                    <table id="datatable-buttons" class="table table-striped jambo_table bulk_action table-bordered">                      <thead>                        <tr>                        <th>Sr.</th>                        <th>Title</th>                        <th>Batch Type</th>                        <th>Start / End Date</th>                        <th>State / City</th>                        <th>PostDate</th>                        <th>Action</th>                        </tr>                      </thead>                      <tbody>                       <?php echo $table;?>                      </tbody>                    </table>                  </div>                </div>              </div>            </div>			          </div>        </div>        <!-- /page content -->			      <!-- footer content -->      <?php include("include/footer.php");?>        <!-- bootstrap-daterangepicker -->    <script src="vendors/moment/min/moment.min.js"></script>    <!-- bootstrap-datetimepicker -->        <script src="vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>    <script type="text/javascript">      $('#myDatepicker1,#myDatepicker2').datetimepicker({        ignoreReadonly: true,        allowInputToggle: true,        format: 'YYYY-MM-DD HH:mm A'    });    </script>                <script type="text/javascript">          $("#state").change(function(){        var id = $(this).val();        $.post("insert_calender.php", {get:"cities",id:id},function(data){            $("#district").empty();            $("#district").prepend("<option value='' selected='selected'>--Select--</option>");            $("#district").append(data);        });    });        </script>      </div>    </div>  </body></html><?php }else{ header('Location:index.php');}?>